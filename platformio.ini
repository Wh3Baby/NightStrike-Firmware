; PlatformIO Project Configuration File
; NightStrike Firmware - Advanced ESP32 Firmware for Offensive Security

[platformio]
default_envs = esp32-devkit
build_cache_dir = .pio/buildcache
cache_dir = .pio/cache
boards_dir = boards
test_dir = tests

extra_configs =
    boards/*.ini
    boards/*/*.ini
    boards/m5stack-cardputer/*.ini
    boards/m5stack-core/*.ini
    boards/m5stack-core2/*.ini
    boards/m5stack-cores3/*.ini
    boards/lilygo-t-embed/*.ini
    boards/lilygo-t-deck/*.ini
    boards/lilygo-t-display-s3/*.ini
    boards/esp32-s3/*.ini
    boards/esp32-c5/*.ini
    boards/cyd-2432s028/*.ini

[env]
platform = espressif32
framework = arduino
board_build.filesystem = 
board_build.partitions = partitions.csv

; Build flags
build_flags =
    -DNIGHTSTRIKE_VERSION='"dev"'
    -DGIT_COMMIT_HASH='"Homebrew"'
    -Os                    ; Оптимизация по размеру
    -Wall
    -Wextra
    -Wno-unused-parameter
    -Wno-unused-variable
    -Wl,--gc-sections      ; Удаление неиспользуемых секций
    -Wl,--print-memory-usage
    -ffunction-sections    ; Разделение функций на секции
    -fdata-sections        ; Разделение данных на секции
    -DCORE_DEBUG_LEVEL=1   ; Уменьшенный уровень отладки для экономии памяти

; Используем ТОЛЬКО локальные библиотеки из .pio/lib/
; Все библиотеки установлены через install_dependencies.sh напрямую из GitHub
lib_extra_dirs = .pio/lib

; НЕ указываем lib_deps - библиотеки уже установлены локально
; PlatformIO автоматически найдет их в lib_extra_dirs
lib_deps =

; Monitor settings
monitor_speed = 115200
monitor_filters = esp32_exception_decoder, send_on_enter, colorize

; Build scripts
extra_scripts =
    pre:scripts/pre_build.py
    post:scripts/post_build.py

; Environment for ESP32 DevKit
[env:esp32-devkit]
board = esp32dev
platform = ${env.platform}
framework = ${env.framework}
build_flags = ${env.build_flags}
lib_extra_dirs = ${env.lib_extra_dirs}
; Библиотеки уже установлены локально, не загружаем через Library Manager
lib_deps =

; Environment for ESP32-S3
[env:esp32-s3]
board = esp32-s3-devkitc-1
platform = ${env.platform}
framework = ${env.framework}
build_flags = ${env.build_flags}
lib_extra_dirs = ${env.lib_extra_dirs}
; Библиотеки уже установлены локально, не загружаем через Library Manager
lib_deps =

; Environment for ESP32-C5
[env:esp32-c5]
board = esp32-c5-devkitc-1
platform = ${env.platform}
framework = ${env.framework}
build_flags = ${env.build_flags}
lib_extra_dirs = ${env.lib_extra_dirs}
; Библиотеки уже установлены локально, не загружаем через Library Manager
lib_deps =

; Environment for M5StickC PLUS2
[env:m5stickc-plus2]
board = esp32dev
platform = ${env.platform}
framework = ${env.framework}
board_build.variant = esp32
board_build.filesystem = 
board_build.partitions = partitions.csv
build_flags = 
    ${env.build_flags}
    -DM5STICKC_PLUS2=1
    -DHAS_SCREEN=1
    -DHAS_IMU=1
    -DHAS_RTC=1
    -DHAS_IR=1
    -DHAS_MIC=1
    -DHAS_BUZZER=1
    -DHAS_LED=1
    ; RF Drivers - только CC1101 и NRF24L01 (оптимизировано)
    -DENABLE_RF_CC1101=1
    -DENABLE_RF_NRF24L01=1
    ; Оптимизация размера
    -DCORE_DEBUG_LEVEL=0
    -ffunction-sections
    -fdata-sections
    -fno-exceptions
    -fno-rtti
    -DNDEBUG
lib_extra_dirs = ${env.lib_extra_dirs}
; Библиотеки уже установлены локально, не загружаем через Library Manager
lib_deps =

; Test environment (без физической платы)
[env:native]
platform = native
; НЕ используем test_framework = unity - он заставляет PlatformIO загружать Unity
; Подключаем Unity вручную через build_flags (без lib_deps!)
test_build_src = yes
build_flags =
    -DNIGHTSTRIKE_VERSION='"dev"'
    -DGIT_COMMIT_HASH='"test"'
    -DTESTING_MODE=1
    -DUNIT_TEST=1
    -Ilib/Unity/src
; Подключаем исходники Unity напрямую (без Library Manager!)
build_src_flags =
    -Ilib/Unity/src
; Используем локальные библиотеки, НЕ загружаем через Library Manager
lib_extra_dirs = lib
; НЕ указываем lib_deps - все библиотеки уже установлены локально
lib_deps =
; Отключаем автоматическую загрузку зависимостей для тестов
lib_ignore = 
    ArduinoJson
    TFT_eSPI
    ESPAsyncWebServer
    NimBLE-Arduino
    FastLED
    M5StickCPlus2
    Unity
    throwtheswitch/Unity
